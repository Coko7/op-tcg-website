# üè¥‚Äç‚ò†Ô∏è One Piece Booster Game

Application web de jeu d'ouverture de boosters One Piece TCG inspir√©e de Pokemon TCG Pocket. Ouvrez des boosters, collectionnez 2,628+ cartes authentiques, compl√©tez vos sets et √©changez avec d'autres joueurs !

## üìã Table des Mati√®res

- [Fonctionnalit√©s](#-fonctionnalit√©s)
- [Installation Rapide](#-installation-rapide)
- [D√©ploiement Docker](#-d√©ploiement-docker)
- [D√©ploiement Raspberry Pi / Portainer](#-d√©ploiement-raspberry-pi--portainer)
- [Architecture Technique](#Ô∏è-architecture-technique)
- [Documentation des Fonctionnalit√©s](#-documentation-des-fonctionnalit√©s)
- [S√©curit√©](#-s√©curit√©)
- [Administration](#Ô∏è-administration)
- [Base de Donn√©es](#Ô∏è-base-de-donn√©es)
- [API REST](#-api-rest)
- [Design System](#-design-system)
- [D√©pannage](#-d√©pannage)
- [Corrections Appliqu√©es](#-corrections-appliqu√©es)

---

## üéØ Fonctionnalit√©s

### Syst√®me de Boosters
- **3 boosters gratuits par jour** - R√©g√©n√©ration automatique toutes les 8 heures
- **Achat de boosters** - 100 Berrys par booster
- **5 cartes par booster** - Distribution garantie par raret√©
- **36+ boosters officiels** - Sets ST-01 √† OP-09+
- **Animations fluides** - Ouverture avec r√©v√©lation progressive

### Collection de Cartes
- **2,628+ cartes authentiques** - Vraies cartes du One Piece TCG
- **6 niveaux de raret√©** - Common, Uncommon, Rare, Leader, Super Rare, Secret Rare
- **Syst√®me de favoris** - Marquez vos cartes pr√©f√©r√©es
- **Recherche & filtres** - Par nom, personnage, raret√©, booster
- **Vente de cartes** - Convertissez les doublons en Berrys
- **Carte vitrine profil** - Affichez votre carte favorite sur le leaderboard

### Marketplace P2P
- **√âchanges entre joueurs** - Achetez et vendez des cartes
- **Prix personnalis√©s** - Fixez vos propres prix (1-999,999 Berrys)
- **Protection compl√®te** - Impossible de vendre la derni√®re copie
- **Limite de 3 annonces** - Par joueur
- **Transactions atomiques** - S√©curit√© garantie

### Syst√®me d'Achievements
- **10+ achievements** - Ouverture de boosters, collection
- **R√©compenses en Berrys** - Jusqu'√† 4,550+ Berrys au total
- **Suivi de progression** - Pourcentages en temps r√©el
- **Achievements par booster** - Compl√©tez chaque set (20%, 50%, 100%)

### R√©compenses Quotidiennes
- **10 Berrys par jour** - Connexion quotidienne r√©compens√©e
- **Protection anti-triche** - Triple v√©rification (frontend + backend + DB)
- **Modal automatique** - Popup √† la premi√®re visite du jour

### Leaderboard
- **Top 3 joueurs** - Class√©s par cartes rares
- **Syst√®me de tiebreak** - Secret Rare > Super Rare > Rare > Uncommon > Common
- **Carte vitrine** - Affichage de la carte favorite du profil

### Notifications Globales (Admin)
- **Annonces √† tous les joueurs**
- **R√©compenses incluses** - Jusqu'√† 10,000 Berrys + 10 boosters
- **Dates d'expiration** - Optionnelles
- **R√©clamation unique** - Une seule fois par joueur

### S√©curit√© Avanc√©e
- **Score: A+** - Protection compl√®te contre les attaques
- **Rate Limiting** - Protection contre le spam
- **Anti-Cheat** - D√©tection de bots et patterns suspects
- **Audit Logging** - Tra√ßabilit√© compl√®te
- **JWT avec Refresh Tokens** - Authentification s√©curis√©e
- **Transactions atomiques** - Pr√©vention des conditions de course

---

## üöÄ Installation Rapide

### Option 1: Docker (Recommand√©)

```bash
# 1. Cloner le projet
git clone <repository-url>
cd OP_game_claude

# 2. Configurer les variables d'environnement
cp .env.example .env
# √âditer .env et d√©finir:
# - JWT_SECRET (g√©n√©rer avec: openssl rand -base64 32)
# - JWT_REFRESH_SECRET (g√©n√©rer diff√©rent)
# - ADMIN_PASSWORD

# 3. Lancer avec Docker Compose
docker-compose up -d

# 4. V√©rifier le statut
docker ps
docker logs op-game-backend
docker logs op-game-frontend

# 5. Acc√©der √† l'application
# Frontend: http://localhost
# Backend: http://localhost:5000
# Admin: http://localhost/admin
```

### Option 2: D√©veloppement Local

**Backend:**
```bash
cd server
npm install
cp .env.example .env
# √âditer .env avec vos secrets
npm run dev
```

**Frontend:**
```bash
npm install
npm run dev
```

---

## üê≥ D√©ploiement Docker

### Structure des Fichiers

```
OP_game_claude/
‚îú‚îÄ‚îÄ docker-compose.yml              # Configuration locale
‚îú‚îÄ‚îÄ docker-compose.portainer.yml    # Configuration Portainer
‚îú‚îÄ‚îÄ Dockerfile.backend              # Multi-stage optimis√©
‚îú‚îÄ‚îÄ Dockerfile.frontend             # Multi-stage optimis√©
‚îú‚îÄ‚îÄ .dockerignore                   # Exclusions
‚îî‚îÄ‚îÄ .env                            # Variables d'environnement
```

### Variables d'Environnement Requises

**Critiques (OBLIGATOIRES en production):**
```env
JWT_SECRET=<g√©n√©rer avec openssl rand -base64 32>
JWT_REFRESH_SECRET=<g√©n√©rer diff√©rent>
ADMIN_PASSWORD=VotreMotDePasseSecuris√©123!
```

**Optionnelles:**
```env
JWT_EXPIRES_IN=15m
JWT_REFRESH_EXPIRES_IN=7d
BCRYPT_ROUNDS=10
ADMIN_USERNAME=admin
ADMIN_EMAIL=admin@yourdomain.com
ALLOWED_ORIGINS=http://localhost,http://your-domain.com
COOKIE_DOMAIN=.yourdomain.com
NODE_ENV=production
BACKEND_PORT=5000
FRONTEND_PORT=80
```

### Build des Images

**Local (x86_64):**
```bash
docker-compose build
docker-compose up -d
```

**Cross-compilation pour ARM64 (Raspberry Pi):**
```bash
# Activer buildx
docker buildx create --use

# Build backend
docker buildx build --platform linux/arm64 \
  -t op-game-backend:latest \
  -f Dockerfile.backend \
  --load \
  .

# Build frontend
docker buildx build --platform linux/arm64 \
  -t op-game-frontend:latest \
  -f Dockerfile.frontend \
  --build-arg VITE_API_URL=/api \
  --load \
  .
```

### Volumes Persistants

```yaml
volumes:
  op_game_data:       # Base de donn√©es SQLite
  op_game_backups:    # Backups automatiques
  op_game_logs:       # Logs d'audit et serveur
```

**Localisation des donn√©es:**
- Backend: `/app/data/database.sqlite`
- Backups: `/app/backups/`
- Logs: `/app/logs/`

### Healthchecks

**Backend:**
```bash
curl http://localhost:5000/health
# Doit retourner: {"status":"ok"}
```

**Frontend:**
```bash
curl http://localhost/
# Doit retourner: HTML de l'application
```

---

## ü•ß D√©ploiement Raspberry Pi / Portainer

### Pr√©requis

- **Raspberry Pi 4** (4GB RAM minimum, 8GB recommand√©)
- **SD Card 32GB+** (Class 10 ou sup√©rieure)
- **Raspberry Pi OS 64-bit**
- **Connexion internet stable**

### √âtape 1: Pr√©paration du Raspberry Pi

```bash
# 1. Mettre √† jour le syst√®me
sudo apt update && sudo apt upgrade -y

# 2. Augmenter le swap (pour les Pi avec peu de RAM)
sudo dphys-swapfile swapoff
sudo nano /etc/dphys-swapfile
# Changer CONF_SWAPSIZE=100 √† CONF_SWAPSIZE=2048
sudo dphys-swapfile setup
sudo dphys-swapfile swapon

# 3. (Optionnel) Configurer une IP statique
sudo nano /etc/dhcpcd.conf
# Ajouter:
# interface eth0
# static ip_address=192.168.1.XXX/24
# static routers=192.168.1.1
# static domain_name_servers=192.168.1.1 8.8.8.8

# 4. Red√©marrer
sudo reboot
```

### √âtape 2: Installation de Docker

```bash
# 1. Installer Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# 2. Ajouter l'utilisateur au groupe docker
sudo usermod -aG docker $USER

# 3. Activer Docker au d√©marrage
sudo systemctl enable docker

# 4. Red√©marrer pour appliquer les changements
sudo reboot
```

### √âtape 3: Installation de Portainer

```bash
# 1. Cr√©er le volume Portainer
docker volume create portainer_data

# 2. Lancer Portainer
docker run -d \
  -p 8000:8000 \
  -p 9443:9443 \
  --name portainer \
  --restart=always \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -v portainer_data:/data \
  portainer/portainer-ce:latest

# 3. V√©rifier le statut
docker ps | grep portainer
```

**Acc√©der √† Portainer:** `https://<raspberry-ip>:9443`

Cr√©ez votre compte admin au premier acc√®s.

### √âtape 4: Build et Transfer des Images

**Sur votre machine de d√©veloppement (Windows/Mac/Linux):**

```bash
cd C:\Users\ppccl\Desktop\OP_game_claude

# Build backend pour ARM64
docker buildx build --platform linux/arm64 \
  -t op-game-backend:latest \
  -f Dockerfile.backend \
  --load \
  .

# Build frontend pour ARM64
docker buildx build --platform linux/arm64 \
  -t op-game-frontend:latest \
  -f Dockerfile.frontend \
  --build-arg VITE_API_URL=/api \
  --load \
  .

# Exporter les images
docker save op-game-backend:latest | gzip > op-game-backend.tar.gz
docker save op-game-frontend:latest | gzip > op-game-frontend.tar.gz

# Transf√©rer vers le Raspberry Pi
scp op-game-backend.tar.gz pi@<raspberry-ip>:~/
scp op-game-frontend.tar.gz pi@<raspberry-ip>:~/
```

**Sur le Raspberry Pi:**

```bash
# Charger les images
docker load < ~/op-game-backend.tar.gz
docker load < ~/op-game-frontend.tar.gz

# V√©rifier
docker images | grep op-game
```

### √âtape 5: Configuration de l'Environnement

```bash
# Cr√©er le r√©pertoire de configuration
mkdir -p ~/op-game-stack
cd ~/op-game-stack

# Cr√©er le fichier .env
nano .env
```

**Contenu du `.env`:**

```env
# CRITIQUES - G√©n√©rer des secrets uniques
JWT_SECRET=<g√©n√©rer avec: openssl rand -base64 32>
JWT_REFRESH_SECRET=<g√©n√©rer diff√©rent du JWT_SECRET>
ADMIN_PASSWORD=VotreMotDePasseS√©curis√©123!

# Configuration r√©seau
ALLOWED_ORIGINS=http://localhost,http://raspberry-op-game.local,http://192.168.1.XXX

# Autres param√®tres
JWT_EXPIRES_IN=15m
JWT_REFRESH_EXPIRES_IN=7d
BCRYPT_ROUNDS=10
ADMIN_USERNAME=admin
ADMIN_EMAIL=admin@yourdomain.com
NODE_ENV=production
```

### √âtape 6: D√©ploiement via Portainer

1. **Acc√©der √† Portainer** : `https://<raspberry-ip>:9443`

2. **Naviguer vers Stacks** : Menu lat√©ral > Stacks > Add stack

3. **Nommer le stack** : `op-game`

4. **Web editor** : Copier le contenu de `docker-compose.portainer.yml`

5. **Environment variables** : Ajouter toutes les variables du fichier `.env`

6. **Deploy the stack** : Cliquer sur "Deploy the stack"

### √âtape 7: V√©rification du D√©ploiement

```bash
# V√©rifier les conteneurs
docker ps

# V√©rifier les logs
docker logs op-game-backend
docker logs op-game-frontend

# Tester l'API
curl http://localhost:5000/health
# Devrait retourner: {"status":"ok"}

# Tester le frontend
curl http://localhost/
```

**Acc√©der √† l'application:**
- Frontend: `http://<raspberry-ip>/`
- Admin: `http://<raspberry-ip>/admin`

### √âtape 8: Configuration Post-D√©ploiement

**Cr√©er un utilisateur admin (si n√©cessaire):**

```bash
docker exec -it op-game-backend node scripts/make-admin.js <username>
```

**Backup automatique:**

```bash
# Cr√©er un cron job pour les backups quotidiens
docker exec op-game-backend sh -c 'crontab -l | { cat; echo "0 2 * * * node /app/scripts/backup-database.js"; } | crontab -'
```

**Monitoring:**

```bash
# Voir les ressources utilis√©es
docker stats

# Voir les logs en temps r√©el
docker logs -f op-game-backend
```

### Optimisations pour Raspberry Pi

**1. R√©duire les limites de ressources**

√âditer `docker-compose.portainer.yml`:

```yaml
services:
  backend:
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
```

**2. Activer log rotation**

```bash
# Limiter la taille des logs Docker
sudo nano /etc/docker/daemon.json
```

Ajouter:
```json
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  }
}
```

```bash
sudo systemctl restart docker
```

---

## üèóÔ∏è Architecture Technique

### Stack Technologique

**Frontend:**
- React 19 + TypeScript
- Tailwind CSS (Design system glassmorphism)
- React Router DOM
- Lucide React (ic√¥nes)
- Vite (build tool)
- Vite PWA Plugin

**Backend:**
- Node.js 20 + Express + TypeScript
- SQLite3 avec better-sqlite3
- JWT + Refresh Tokens
- bcryptjs (hashing)
- Helmet + CORS (s√©curit√©)
- express-rate-limit
- Zod (validation)

**Infrastructure:**
- Docker + Docker Compose
- Multi-stage builds optimis√©s
- Nginx (reverse proxy frontend)
- Healthchecks automatiques
- Volumes persistants

### Structure du Projet

```
OP_game_claude/
‚îú‚îÄ‚îÄ src/                          # Frontend React
‚îÇ   ‚îú‚îÄ‚îÄ components/               # Composants r√©utilisables
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ui/                   # Design system
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Card.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DailyRewardModal.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îú‚îÄ‚îÄ pages/                    # Pages principales
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Home.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Boosters.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Collection.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Achievements.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Marketplace.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Leaderboard.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Admin.tsx
‚îÇ   ‚îú‚îÄ‚îÄ services/                 # Services API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ gameService.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ vegapullService.ts
‚îÇ   ‚îú‚îÄ‚îÄ contexts/                 # React contexts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AuthContext.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ToastContext.tsx
‚îÇ   ‚îî‚îÄ‚îÄ types/                    # Types TypeScript
‚îÇ
‚îú‚îÄ‚îÄ server/                       # Backend Node.js
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ controllers/          # Contr√¥leurs API
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ authController.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ userController.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cardController.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ achievementController.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ marketplaceController.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ leaderboardController.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dashboardController.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ notificationController.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models/               # Mod√®les de donn√©es
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ User.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Card.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Booster.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Achievement.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ MarketplaceListing.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/             # Services m√©tier
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ BoosterService.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AchievementService.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ CardUpdateService.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ middleware/           # Middlewares
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ security.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ antiCheat.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ validation.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ routes/               # Routes API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ utils/                # Utilitaires
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ migrations.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auditLogger.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logger.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ scripts/              # Scripts d'administration
‚îÇ   ‚îú‚îÄ‚îÄ data/                     # Base de donn√©es
‚îÇ   ‚îú‚îÄ‚îÄ backups/                  # Backups automatiques
‚îÇ   ‚îî‚îÄ‚îÄ logs/                     # Logs d'audit
‚îÇ
‚îú‚îÄ‚îÄ public/                       # Assets statiques
‚îÇ   ‚îú‚îÄ‚îÄ data/vegapull/            # Donn√©es des cartes
‚îÇ   ‚îî‚îÄ‚îÄ images/                   # Images des cartes
‚îÇ
‚îú‚îÄ‚îÄ docker-compose.yml            # Config Docker locale
‚îú‚îÄ‚îÄ docker-compose.portainer.yml  # Config Docker Portainer
‚îú‚îÄ‚îÄ Dockerfile.backend            # Image backend
‚îú‚îÄ‚îÄ Dockerfile.frontend           # Image frontend
‚îî‚îÄ‚îÄ .dockerignore                 # Exclusions Docker
```

### Flux de Donn√©es

```
User ‚Üí Frontend (React)
  ‚Üì
API Service (axios)
  ‚Üì
Backend (Express)
  ‚Üì
Middleware (Auth, Security, Anti-Cheat)
  ‚Üì
Controller
  ‚Üì
Service (Business Logic)
  ‚Üì
Model (Database)
  ‚Üì
SQLite Database
```

---

## üìö Documentation des Fonctionnalit√©s

### 1. Authentification & Gestion Utilisateur

#### Inscription & Connexion

**Description:** Cr√©ation de compte et connexion s√©curis√©e avec JWT.

**Endpoints:**
- `POST /api/auth/register` - Cr√©er un compte
- `POST /api/auth/login` - Se connecter
- `POST /api/auth/logout` - Se d√©connecter
- `POST /api/auth/refresh` - Renouveler le token
- `GET /api/auth/me` - Informations utilisateur

**S√©curit√©:**
- Hashing bcrypt (12 rounds configurables)
- Username 3-30 caract√®res
- Password minimum 6 caract√®res
- V√©rification unicit√© username/email
- Audit logging de toutes les tentatives

**Base de donn√©es:** `users`, `user_sessions`

**Fichiers:**
- `server/src/controllers/authController.ts`
- `server/src/models/User.ts`
- `src/pages/Login.tsx`, `src/pages/Register.tsx`

---

#### JWT avec Refresh Tokens

**Description:** Authentification moderne avec tokens courts et longs.

**Fonctionnement:**
- **Access Token:** 15 minutes (pour les requ√™tes API)
- **Refresh Token:** 7 jours (pour obtenir de nouveaux access tokens)
- Stockage en cookies httpOnly (XSS-safe)
- Session tracking en base de donn√©es

**S√©curit√©:**
- Secrets obligatoires en production
- HttpOnly + Secure + SameSite cookies
- Rotation des refresh tokens
- Invalidation √† la d√©connexion

**Fichiers:**
- `server/src/controllers/authController.ts`
- `server/src/middleware/auth.ts`

---

#### R√¥le Admin

**Description:** Comptes avec privil√®ges √©lev√©s pour l'administration.

**Cr√©ation d'un admin:**

```bash
# M√©thode 1: Script (recommand√©)
docker exec -it op-game-backend node scripts/make-admin.js <username>

# M√©thode 2: SQL direct
docker exec -it op-game-backend sqlite3 /app/data/database.sqlite
UPDATE users SET is_admin = 1 WHERE username = 'username';

# M√©thode 3: Variable d'environnement
# D√©finir ADMIN_USERNAME, ADMIN_EMAIL, ADMIN_PASSWORD dans .env
# L'admin est cr√©√© automatiquement au d√©marrage
```

**Fichiers:**
- `server/src/middleware/auth.ts` (requireAdmin)
- `src/pages/Admin.tsx`

---

### 2. Syst√®me de Boosters

#### Boosters Gratuits Quotidiens

**Description:** 3 boosters gratuits qui se r√©g√©n√®rent toutes les 8 heures.

**Endpoints:**
- `GET /api/users/boosters/status` - Statut des boosters
- `POST /api/users/boosters/open` - Ouvrir un booster gratuit

**Fonctionnement:**
- Maximum 3 boosters stock√©s
- 1 booster r√©g√©n√©r√© toutes les 8 heures
- Timer d√©marre quand < 3 boosters
- Calcul c√¥t√© serveur uniquement

**S√©curit√©:**
- Validation serveur du timer
- Transaction atomique pour d√©duction
- Anti-cheat: max 10/min, 100/h
- V√©rification timestamps futurs

**Base de donn√©es:** `users` (available_boosters, next_booster_time)

**Fichiers:**
- `server/src/controllers/userController.ts`
- `src/pages/Home.tsx`

---

#### Ouverture de Boosters

**Description:** Ouvre un booster et g√©n√®re 5 cartes avec distribution par raret√©.

**Endpoints:**
- `POST /api/users/boosters/open`

**Distribution des Raret√©s:**
- **Common:** 58%
- **Uncommon:** 26%
- **Rare:** 10%
- **Leader:** 3%
- **Super Rare:** 2.5%
- **Secret Rare:** 0.5%

**Fonctionnement:**
1. V√©rifier disponibilit√© du booster
2. D√©duire 1 booster (transaction atomique)
3. G√©n√©rer 5 cartes (BoosterService)
4. Ajouter √† la collection (ou incr√©menter quantit√©)
5. Enregistrer l'historique
6. Mettre √† jour les achievements

**S√©curit√©:**
- G√©n√©ration serveur (pas de manipulation client)
- Transaction atomique (rollback si erreur)
- Rate limiting via anti-cheat
- Audit logging

**Base de donn√©es:** `boosters`, `cards`, `user_collections`, `booster_openings`

**Fichiers:**
- `server/src/services/BoosterService.ts`
- `server/src/controllers/userController.ts`
- `src/pages/Boosters.tsx`

---

#### Achat de Boosters avec Berrys

**Description:** Acheter des boosters suppl√©mentaires avec la monnaie du jeu.

**Endpoints:**
- `POST /api/users/boosters/buy`
- `GET /api/users/berrys`

**Prix:** 100 Berrys = 1 booster

**Fonctionnement:**
1. V√©rifier solde (‚â• 100 Berrys)
2. D√©duire 100 Berrys (transaction atomique)
3. M√™me g√©n√©ration que booster gratuit

**S√©curit√©:**
- Calcul prix c√¥t√© serveur
- Transaction atomique avec v√©rification solde
- Maximum Berrys: 999,999,999
- Audit logging

**Fichiers:**
- `server/src/controllers/userController.ts`

---

### 3. Gestion de la Collection

#### Visualisation de la Collection

**Description:** Vue compl√®te des cartes poss√©d√©es avec m√©tadonn√©es.

**Endpoints:**
- `GET /api/users/collection`
- `GET /api/users/stats`

**Donn√©es affich√©es:**
- Nom, personnage, raret√©, type, couleur
- Attaque, d√©fense, co√ªt, pouvoir, counter
- Description, capacit√©s sp√©ciales
- Image + image de secours
- Quantit√© poss√©d√©e
- Date d'obtention
- Statut favori

**Filtres disponibles:**
- Par raret√©
- Par booster
- Par nom/personnage (recherche)
- Favoris uniquement

**Base de donn√©es:** `user_collections`, `cards`

**Fichiers:**
- `server/src/controllers/userController.ts`
- `src/pages/Collection.tsx`

---

#### Vente de Cartes

**Description:** Convertir les doublons en Berrys.

**Endpoints:**
- `POST /api/users/cards/sell`

**Prix de Vente par Raret√©:**
- **Common:** 10 Berrys
- **Uncommon:** 25 Berrys
- **Rare:** 50 Berrys
- **Leader:** 100 Berrys
- **Super Rare:** 150 Berrys
- **Secret Rare:** 500 Berrys

**R√®gles:**
- Doit poss√©der au moins 2 copies (garde toujours 1 minimum)
- Quantit√© max par transaction: 1-1000
- Transaction atomique

**S√©curit√©:**
- Calcul prix serveur uniquement
- V√©rification propri√©t√©
- Contrainte minimum 1 copie
- Cap Berrys respect√©
- Audit logging

**Fichiers:**
- `server/src/controllers/userController.ts`

---

#### Syst√®me de Favoris

**Description:** Marquer des cartes comme favorites pour acc√®s rapide.

**Endpoints:**
- `POST /api/users/collection/favorite/:cardId`

**Fonctionnement:**
- Toggle on/off avec un seul endpoint
- Plusieurs favoris autoris√©s
- Ind√©pendant de la carte vitrine profil

**Base de donn√©es:** `user_collections` (is_favorite)

**Fichiers:**
- `server/src/controllers/userController.ts`
- `src/pages/Collection.tsx`

---

#### Carte Vitrine Profil

**Description:** Une carte favorite affich√©e sur le profil et le leaderboard.

**Endpoints:**
- `PUT /api/users/profile/favorite-card`
- `GET /api/users/me`

**R√®gles:**
- Une seule carte √† la fois
- Doit poss√©der la carte
- Carte doit √™tre active
- Peut √™tre effac√©e (null)

**Base de donn√©es:** `users` (favorite_card_id)

**Fichiers:**
- `server/src/controllers/userController.ts`
- `src/pages/ProfileSettings.tsx`

---

### 4. Achievements

#### Syst√®me d'Achievements

**Description:** D√©fis avec r√©compenses en Berrys pour progresser dans le jeu.

**Endpoints:**
- `GET /api/achievements` - Liste avec progression
- `GET /api/achievements/stats` - Statistiques
- `POST /api/achievements/:id/claim` - R√©clamer r√©compense

**Types d'Achievements:**

1. **Ouverture de Boosters (5 niveaux):**
   - First Booster (1) ‚Üí 50 Berrys
   - Novice Collector (10) ‚Üí 100 Berrys
   - Dedicated Collector (50) ‚Üí 250 Berrys
   - Master Collector (100) ‚Üí 500 Berrys
   - Legend of Boosters (250) ‚Üí 1000 Berrys

2. **Collection (5 niveaux):**
   - First Collection (10 cartes uniques) ‚Üí 50 Berrys
   - Growing Collection (50) ‚Üí 150 Berrys
   - Impressive Library (100) ‚Üí 300 Berrys
   - Epic Collection (200) ‚Üí 600 Berrys
   - Ultimate Collector (500) ‚Üí 1500 Berrys

3. **Compl√©tion de Boosters (par set):**
   - Explorer (20%) ‚Üí 100 Berrys
   - Collector (50%) ‚Üí 250 Berrys
   - Complete Master (100%) ‚Üí 500 Berrys

**Total Potential:** 4,550+ Berrys

**Progression:**
- Mise √† jour automatique apr√®s chaque action
- Pourcentage affich√© en temps r√©el
- Compl√©tion quand progress ‚â• threshold

**R√©clamation:**
- Manuelle (bouton "Claim")
- Une seule fois par achievement
- Transaction atomique
- Ajout imm√©diat des Berrys

**S√©curit√©:**
- Calcul serveur uniquement
- V√©rification compl√©tion avant claim
- Protection double-claim
- Tol√©rance +10% sur progress
- Audit logging

**Base de donn√©es:** `achievements`, `user_achievements`

**Fichiers:**
- `server/src/models/Achievement.ts`
- `server/src/services/AchievementService.ts`
- `server/src/controllers/achievementController.ts`
- `src/pages/Achievements.tsx`

---

### 5. R√©compenses Quotidiennes

**Description:** 10 Berrys gratuits chaque jour √† la connexion.

**Endpoints:**
- `POST /api/users/daily-reward`
- `GET /api/users/daily-reward/status`

**Fonctionnement:**
- Une fois par jour calendaire (UTC)
- R√©compense: 10 Berrys
- Modal automatique √† la premi√®re visite
- Bouton manuel disponible

**Protection Triple:**
1. **Frontend:** localStorage pour UX
2. **Backend:** Comparaison de dates
3. **Database:** Clause WHERE atomique

```sql
UPDATE users
SET berrys = berrys + 10, last_daily_reward = ?
WHERE id = ? AND (last_daily_reward IS NULL OR date(last_daily_reward) < date(?))
```

**S√©curit√©:**
- Protection race condition
- V√©rification date c√¥t√© serveur
- Cap Berrys respect√©
- Audit logging (succ√®s et √©checs)

**Base de donn√©es:** `users` (last_daily_reward)

**Fichiers:**
- `server/src/controllers/userController.ts`
- `src/components/DailyRewardModal.tsx`
- `src/pages/Home.tsx`

---

### 6. Marketplace P2P

#### Cr√©ation d'Annonces

**Description:** Vendre des cartes √† d'autres joueurs avec prix personnalis√©.

**Endpoints:**
- `POST /api/marketplace/listings`

**R√®gles:**
- Doit poss√©der au moins 2 copies de la carte
- Prix: 1-999,999 Berrys
- Maximum 3 annonces actives par joueur
- Pas de double annonce pour la m√™me carte
- Carte reste en inventaire jusqu'√† vente

**S√©curit√©:**
- V√©rification propri√©t√©
- V√©rification quantit√© minimum (2+)
- Validation prix
- Limite annonces (3 max)
- V√©rification carte active
- Transaction atomique
- Audit logging

**Base de donn√©es:** `marketplace_listings`

**Fichiers:**
- `server/src/controllers/marketplaceController.ts`
- `src/pages/Marketplace.tsx`

---

#### Achats sur le Marketplace

**Description:** Acheter des cartes list√©es par d'autres joueurs.

**Endpoints:**
- `GET /api/marketplace/listings` - Toutes les annonces actives
- `GET /api/marketplace/my-listings` - Mes annonces
- `POST /api/marketplace/listings/:id/purchase` - Acheter

**Fonctionnement (Transaction Atomique):**
1. V√©rifier annonce active
2. V√©rifier solde acheteur
3. Emp√™cher auto-achat
4. V√©rifier propri√©t√© vendeur
5. D√©duire Berrys acheteur
6. Ajouter Berrys vendeur
7. Retirer carte vendeur
8. Ajouter carte acheteur
9. Marquer annonce comme vendue
10. Rollback complet si erreur

**S√©curit√©:**
- Transaction atomique multi-√©tapes
- Pr√©vention auto-achat
- V√©rification solde
- V√©rification propri√©t√© vendeur
- Rollback automatique
- Audit logging

**Fichiers:**
- `server/src/controllers/marketplaceController.ts`
- `server/src/models/MarketplaceListing.ts`

---

#### Annulation d'Annonces

**Description:** Retirer une annonce du marketplace.

**Endpoints:**
- `DELETE /api/marketplace/listings/:id`

**R√®gles:**
- Seul le vendeur peut annuler
- Annonce doit √™tre active
- Pas de p√©nalit√©
- Carte reste en inventaire

**Fichiers:**
- `server/src/controllers/marketplaceController.ts`

---

### 7. Leaderboard

**Description:** Classement des top 3 joueurs par raret√© des cartes.

**Endpoints:**
- `GET /api/leaderboard`

**Algorithme de Classement:**

```
Priorit√© 1: Nombre de Secret Rare
Priorit√© 2: Nombre de Super Rare
Priorit√© 3: Nombre de Rare
Priorit√© 4: Nombre de Uncommon
Priorit√© 5: Nombre de Common
```

**Affichage:**
- Username
- Nombre de cartes par raret√©
- Carte vitrine profil
- Top 3 uniquement

**Base de donn√©es:** `users`, `user_collections`, `cards`

**Fichiers:**
- `server/src/controllers/leaderboardController.ts`
- `src/pages/Leaderboard.tsx`

---

### 8. Notifications Globales (Admin)

**Description:** Annonces envoy√©es √† tous les joueurs avec r√©compenses optionnelles.

**Endpoints Admin:**
- `POST /api/admin/notifications` - Cr√©er
- `GET /api/admin/notifications` - Lister toutes
- `DELETE /api/admin/notifications/:id` - D√©sactiver

**Endpoints Utilisateur:**
- `GET /api/notifications` - Non lues
- `POST /api/notifications/:id/claim` - R√©clamer

**Param√®tres:**
- **Titre:** 3-100 caract√®res
- **Message:** 10-1000 caract√®res
- **R√©compense Berrys:** 0-10,000
- **R√©compense Boosters:** 0-10
- **Date d'expiration:** Optionnelle

**Fonctionnement:**
1. Admin cr√©e notification
2. Tous les utilisateurs la voient
3. R√©clamation une seule fois par utilisateur
4. R√©compenses ajout√©es imm√©diatement
5. Marque comme lue

**S√©curit√©:**
- Cr√©ation admin uniquement
- Validation longueur titre/message
- Limites r√©compenses
- Protection double-claim
- V√©rification expiration
- Transaction atomique
- Audit logging

**Base de donn√©es:** `notifications`, `user_notifications`

**Fichiers:**
- `server/src/controllers/notificationController.ts`

---

## üîí S√©curit√©

### Score de S√©curit√©: A+

Toutes les vuln√©rabilit√©s majeures sont mitig√©es avec des mesures compl√®tes.

### Protection contre les Injections SQL

**M√©thodes de Protection:**
- ‚úÖ **Requ√™tes param√©tr√©es** - 100% des requ√™tes utilisent des placeholders
- ‚úÖ **D√©tection de patterns** - Middleware bloque les keywords SQL suspects
- ‚úÖ **Validation d'entr√©es** - Taille max 10,000 caract√®res
- ‚úÖ **Blacklist de commandes** - ATTACH, PRAGMA bloqu√©s
- ‚úÖ **Audit logging** - Toutes les tentatives enregistr√©es

**Patterns D√©tect√©s:**
```
SELECT, INSERT, UPDATE, DELETE, DROP, UNION
--, #, /*, */
OR 1=1, AND 1=1
```

**Fichiers:**
- `server/src/middleware/security.ts`
- `server/src/utils/database.ts`

---

### Protection XSS & Path Traversal

**Protection XSS:**
- ‚úÖ Content-Security-Policy headers
- ‚úÖ X-XSS-Protection header
- ‚úÖ Sanitization des inputs
- ‚úÖ HTML entity encoding

**Protection Path Traversal:**
- ‚úÖ D√©tection `../`, `.\`, encodages URL
- ‚úÖ Validation paths, query params, body
- ‚úÖ Audit logging

**Headers de S√©curit√©:**
```
Content-Security-Policy: default-src 'self'; script-src 'self'
X-Content-Type-Options: nosniff
X-Frame-Options: DENY
X-XSS-Protection: 1; mode=block
Strict-Transport-Security: max-age=31536000
Referrer-Policy: strict-origin-when-cross-origin
Permissions-Policy: geolocation=(), microphone=(), camera=()
```

---

### Rate Limiting

**Limites par Endpoint:**

| Endpoint | Production | Dev | Fen√™tre |
|----------|-----------|-----|---------|
| Global | 200 req | 1000 req | 15 min |
| Auth (`/api/auth/*`) | 10 req | 50 req | 15 min |
| Admin (`/api/admin/*`) | 20 req | 100 req | 15 min |

**Impl√©mentation:**
- express-rate-limit
- Tracking par IP
- Headers informatifs
- R√©ponses 429 automatiques

**Fichiers:**
- `server/src/app.ts`

---

### Anti-Cheat System

**D√©tection Multi-Couches:**

**1. Limites par Action:**

```typescript
{
  open_booster: { maxPerMin: 10, maxPerHour: 100, minDelay: 1000 },
  buy_booster: { maxPerMin: 5, maxPerHour: 50, minDelay: 2000 },
  sell_card: { maxPerMin: 20, maxPerHour: 200, minDelay: 500 },
  claim_achievement: { maxPerMin: 10, maxPerHour: 100, minDelay: 1000 },
  claim_daily_reward: { maxPerMin: 2, maxPerHour: 5, minDelay: 5000 }
}
```

**2. Syst√®me de Score de Suspicion:**

- Limite minute d√©pass√©e: +10 points
- Limite heure d√©pass√©e: +20 points
- D√©lai minimum viol√©: +5 points
- Pattern de bot d√©tect√©: +30 points
- **Auto-block √† 100 points pendant 30 minutes**

**3. D√©tection de Bots:**

Analyse statistique des intervalles entre actions:
- √âcart-type < 100ms et moyenne < 2s = bot probable

**4. V√©rifications de Coh√©rence:**

**Ressources:**
- Berrys: 0 √† 999,999,999
- Boosters: 0 √† 10
- Auto-correction + audit log si anomalie

**Temporelles:**
- Pas de timestamps futurs (tol√©rance 1 min)
- Auto-correction + audit log

**Fichiers:**
- `server/src/middleware/antiCheat.ts`

---

### Transactions Atomiques

**Op√©rations Prot√©g√©es:**

Toutes les op√©rations critiques utilisent `Database.transaction()` avec clauses WHERE:

```typescript
await Database.transaction(async () => {
  const result = await Database.run(`
    UPDATE users
    SET available_boosters = available_boosters - 1
    WHERE id = ? AND available_boosters > 0
  `, [userId]);

  if (result.changes === 0) {
    throw new Error('No boosters available');
  }
  // ... suite de la transaction
});
```

**Liste des Op√©rations:**
- Ouverture de booster
- Achat de booster
- Vente de carte
- R√©clamation daily reward
- R√©clamation achievement
- Achat marketplace
- R√©clamation notification

---

### CORS & Cookies

**Configuration CORS:**
- Whitelist d'origins (ALLOWED_ORIGINS env var)
- Credentials autoris√©s uniquement pour whitelist
- Logging des origins bloqu√©es
- Blocage automatique des origins non autoris√©es

**Configuration Cookies:**
```typescript
{
  httpOnly: true,           // Protection XSS
  secure: NODE_ENV === 'production',  // HTTPS uniquement en prod
  sameSite: 'lax',         // Protection CSRF
  domain: COOKIE_DOMAIN,   // Partage entre sous-domaines
  maxAge: 7 * 24 * 60 * 60 * 1000  // 7 jours
}
```

**Fichiers:**
- `server/src/app.ts`

---

### Audit Logging

**Actions Logg√©es:**

**Authentification:**
- Login, logout, register
- Token refresh
- √âchecs de login

**Gameplay:**
- Ouverture booster
- Achat booster
- Vente carte
- Achievement compl√©t√©/r√©clam√©
- Daily reward

**Marketplace:**
- Cr√©ation annonce
- Achat
- Annulation

**Admin:**
- Toutes les actions admin

**S√©curit√©:**
- Tentatives injection SQL
- Tentatives XSS
- Path traversal
- Rate limits
- Auto-blocks

**Niveaux de S√©v√©rit√©:**
- **INFO:** Op√©rations normales
- **WARNING:** Tentatives √©chou√©es
- **ERROR:** Erreurs syst√®me
- **CRITICAL:** Violations s√©curit√©, auto-blocks

**Donn√©es Captur√©es:**
- user_id
- action
- details (JSON)
- severity
- ip_address
- user_agent
- timestamp

**R√©tention:** 90 jours (configurable)

**Base de donn√©es:** `audit_logs`

**Fichiers:**
- `server/src/utils/auditLogger.ts`

---

### Validation User-Agent

**User-Agents Bloqu√©s:**

```
sqlmap, nikto, nmap, masscan, burp,
dirbuster, acunetix
```

**R√©ponse:** 403 Forbidden + audit log

**Fichiers:**
- `server/src/middleware/security.ts`

---

### Tests de S√©curit√©

**Scripts Disponibles:**

```bash
cd server

# Test complet de p√©n√©tration
node security-penetration-tests.js

# V√©rification configuration s√©curit√©
node security-check.js

# Test s√©curit√© notifications
node test-notification-security.js
```

**Tests Couverts:**
- 5 payloads SQL injection
- 5 payloads XSS
- 4 payloads path traversal
- Rate limiting
- Auth bypass
- User-agents malveillants
- Limites requ√™tes
- Exploits business logic

---

### Checklist Production

**Avant D√©ploiement:**
- [ ] Changer TOUS les secrets (JWT_SECRET, JWT_REFRESH_SECRET)
- [ ] NODE_ENV=production
- [ ] Configurer ALLOWED_ORIGINS avec domaines r√©els
- [ ] Activer HTTPS avec certificat SSL valide
- [ ] V√©rifier .env dans .gitignore
- [ ] npm audit et correction vuln√©rabilit√©s
- [ ] Tester backups database
- [ ] Configurer retention logs
- [ ] Limiter acc√®s SSH/admin
- [ ] Ex√©cuter security-check.js
- [ ] Ex√©cuter security-penetration-tests.js

**Apr√®s D√©ploiement:**
- [ ] V√©rifier headers s√©curit√© pr√©sents
- [ ] Tester rate limiting
- [ ] V√©rifier audit logs
- [ ] Tester rotation tokens JWT
- [ ] V√©rifier HTTPS fonctionne
- [ ] Tester disaster recovery

---

## üõ°Ô∏è Administration

### Acc√®s Admin

**Cr√©er un Admin:**

```bash
# M√©thode 1: Script
docker exec -it op-game-backend node scripts/make-admin.js <username>

# M√©thode 2: SQL Direct
docker exec -it op-game-backend sqlite3 /app/data/database.sqlite
UPDATE users SET is_admin = 1 WHERE username = 'username';

# M√©thode 3: Variables d'Environnement
# Dans .env:
ADMIN_USERNAME=admin
ADMIN_EMAIL=admin@example.com
ADMIN_PASSWORD=SecurePassword123!
# Admin cr√©√© automatiquement au premier d√©marrage
```

**Acc√®s Interface:**
- Direct: `http://localhost:5000/admin`
- Via frontend: `http://localhost/admin`

---

### Dashboard Admin

**Acc√®s:** `/admin`

**Statistiques Disponibles:**

**Utilisateurs:**
- Total utilisateurs
- Admins
- Actifs aujourd'hui
- Actifs cette semaine
- Nouveaux cette semaine

**√âconomie:**
- Total Berrys en circulation
- Moyenne par joueur
- Distribution

**Boosters:**
- Total ouverts
- Ouverts aujourd'hui
- Ouverts cette semaine

**Cartes:**
- Total cartes
- Cartes actives
- Cartes en collections
- Moyenne par joueur

**Achievements:**
- Total achievements
- Compl√©tions
- R√©clamations
- Taux de compl√©tion

**S√©curit√© (24h):**
- √âchecs de login
- Activit√©s suspectes
- √âv√©nements critiques

**Top 10:**
- Joueurs par Berrys

**Fichiers:**
- `server/src/controllers/dashboardController.ts`
- `src/pages/Admin.tsx`

---

### Gestion des Notifications

**Cr√©er une Notification:**

```bash
curl -X POST http://localhost:5000/api/admin/notifications \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -d '{
    "title": "√âv√©nement Weekend !",
    "message": "Profitez de 500 Berrys et 1 booster gratuit ! Merci de jouer !",
    "reward_berrys": 500,
    "reward_boosters": 1,
    "expires_at": "2025-12-31T23:59:59Z"
  }'
```

**Endpoints:**
- `POST /api/admin/notifications` - Cr√©er
- `GET /api/admin/notifications` - Lister toutes
- `DELETE /api/admin/notifications/:id` - D√©sactiver

**Param√®tres:**
- **title:** 3-100 caract√®res
- **message:** 10-1000 caract√®res
- **reward_berrys:** 0-10,000
- **reward_boosters:** 0-10
- **expires_at:** ISO 8601 (optionnel)

---

### Utilisateurs en Ligne

**Endpoint:** `GET /api/admin/dashboard/online`

**D√©finition "En ligne":** Derni√®re activit√© < 5 minutes

**Affichage:**
- Username
- Dernier login
- Berrys
- Boosters disponibles

---

### Activit√© R√©cente

**Endpoint:** `GET /api/admin/dashboard/activity?limit=100`

**Actions Suivies:**
- user_login
- user_register
- booster_opened
- booster_purchased
- achievement_claimed
- daily_reward_claimed
- marketplace_purchase
- card_sold

**Donn√©es:**
- User ID
- Action
- Details
- Timestamp

---

### Scripts Admin Utiles

**Cr√©er Admin:**
```bash
docker exec -it op-game-backend node scripts/make-admin.js <username>
```

**Backup Database:**
```bash
docker exec -it op-game-backend node scripts/backup-database.js
```

**R√©initialiser Password:**
```bash
docker exec -it op-game-backend node scripts/reset-password.bat <username>
```

**Envoyer Compensation:**
```bash
docker exec -it op-game-backend node scripts/send-compensation.js <userId> <berrys> <boosters>
```

**Rotation Logs:**
```bash
docker exec -it op-game-backend node scripts/log-rotation.js
```

---

## üóÑÔ∏è Base de Donn√©es

### Technologie

- **SQLite3** avec better-sqlite3
- **Mode WAL** (Write-Ahead Logging) - lectures concurrentes
- **Foreign keys** activ√©es
- **Auto-backup** avant migrations
- **Version:** 16+ (sch√©ma)

### Localisation

**Local:**
- `server/data/database.sqlite`

**Docker:**
- `/app/data/database.sqlite`
- Volume: `op_game_data`

### Migrations

**Syst√®me:**
- Migrations incr√©mentales avec version tracking
- Auto-ex√©cution au d√©marrage serveur
- Backup avant chaque migration
- Rollback si erreur
- Cleanup vieux backups (garde 5 derniers)

**Fichiers:**
- `server/src/utils/migrations.ts` - D√©finitions
- `server/scripts/run-migrations.js` - Runner
- `server/src/utils/database.ts` - Utilitaires

**Ex√©cution Manuelle:**
```bash
cd server
node scripts/run-migrations.js
```

---

### Sch√©ma des Tables

#### users

```sql
CREATE TABLE users (
  id TEXT PRIMARY KEY,
  username TEXT UNIQUE NOT NULL,
  password_hash TEXT NOT NULL,
  email TEXT UNIQUE,
  berrys INTEGER DEFAULT 0,
  available_boosters INTEGER DEFAULT 3,
  boosters_opened_today INTEGER DEFAULT 0,
  next_booster_time TEXT,
  last_booster_opened TEXT,
  last_daily_reward TEXT,
  last_login TEXT,
  is_admin INTEGER DEFAULT 0,
  is_active INTEGER DEFAULT 1,
  favorite_card_id TEXT,
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,
  updated_at TEXT DEFAULT CURRENT_TIMESTAMP,

  FOREIGN KEY (favorite_card_id) REFERENCES cards(id),
  CHECK(berrys >= 0 AND berrys <= 999999999),
  CHECK(available_boosters >= 0 AND available_boosters <= 10),
  CHECK(is_admin IN (0, 1)),
  CHECK(is_active IN (0, 1))
);
```

#### cards

```sql
CREATE TABLE cards (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  character_name TEXT,
  rarity TEXT NOT NULL,
  type TEXT NOT NULL,
  color TEXT,
  cost INTEGER,
  power INTEGER,
  counter INTEGER,
  attack INTEGER,
  defense INTEGER,
  description TEXT,
  special_ability TEXT,
  image_url TEXT,
  fallback_image_url TEXT,
  booster_id TEXT,
  vegapull_id TEXT UNIQUE,
  is_active INTEGER DEFAULT 1,
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,
  updated_at TEXT DEFAULT CURRENT_TIMESTAMP,

  CHECK(is_active IN (0, 1))
);
```

#### user_collections

```sql
CREATE TABLE user_collections (
  user_id TEXT NOT NULL,
  card_id TEXT NOT NULL,
  quantity INTEGER DEFAULT 1,
  obtained_at TEXT DEFAULT CURRENT_TIMESTAMP,
  is_favorite INTEGER DEFAULT 0,

  PRIMARY KEY (user_id, card_id),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (card_id) REFERENCES cards(id) ON DELETE CASCADE,

  CHECK(quantity > 0),
  CHECK(is_favorite IN (0, 1))
);
```

#### boosters

```sql
CREATE TABLE boosters (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  series TEXT NOT NULL,
  release_date TEXT,
  total_cards INTEGER,
  description TEXT,
  image_url TEXT,
  vegapull_id TEXT UNIQUE,
  is_active INTEGER DEFAULT 1,
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,
  updated_at TEXT DEFAULT CURRENT_TIMESTAMP
);
```

#### booster_openings

```sql
CREATE TABLE booster_openings (
  id TEXT PRIMARY KEY,
  user_id TEXT NOT NULL,
  booster_id TEXT,
  cards_obtained TEXT,
  opened_at TEXT DEFAULT CURRENT_TIMESTAMP,

  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

#### achievements

```sql
CREATE TABLE achievements (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  description TEXT,
  threshold INTEGER NOT NULL,
  reward_berrys INTEGER DEFAULT 0,
  category TEXT NOT NULL,
  type TEXT NOT NULL,
  booster_id TEXT,
  is_active INTEGER DEFAULT 1,
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,

  CHECK(threshold > 0),
  CHECK(reward_berrys >= 0)
);
```

#### user_achievements

```sql
CREATE TABLE user_achievements (
  id TEXT PRIMARY KEY,
  user_id TEXT NOT NULL,
  achievement_id TEXT NOT NULL,
  progress INTEGER DEFAULT 0,
  completed_at TEXT,
  is_claimed INTEGER DEFAULT 0,
  claimed_at TEXT,

  UNIQUE(user_id, achievement_id),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (achievement_id) REFERENCES achievements(id) ON DELETE CASCADE
);
```

#### marketplace_listings

```sql
CREATE TABLE marketplace_listings (
  id TEXT PRIMARY KEY,
  seller_id TEXT NOT NULL,
  card_id TEXT NOT NULL,
  price INTEGER NOT NULL,
  status TEXT DEFAULT 'active',
  buyer_id TEXT,
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,
  sold_at TEXT,

  FOREIGN KEY (seller_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (card_id) REFERENCES cards(id) ON DELETE CASCADE,
  FOREIGN KEY (buyer_id) REFERENCES users(id) ON DELETE SET NULL,

  CHECK(price > 0),
  CHECK(status IN ('active', 'sold', 'cancelled'))
);
```

#### notifications

```sql
CREATE TABLE notifications (
  id TEXT PRIMARY KEY,
  title TEXT NOT NULL,
  message TEXT NOT NULL,
  reward_berrys INTEGER DEFAULT 0,
  reward_boosters INTEGER DEFAULT 0,
  is_active INTEGER DEFAULT 1,
  created_by TEXT,
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,
  expires_at TEXT,

  FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL,

  CHECK(reward_berrys >= 0 AND reward_berrys <= 10000),
  CHECK(reward_boosters >= 0 AND reward_boosters <= 10)
);
```

#### user_notifications

```sql
CREATE TABLE user_notifications (
  id TEXT PRIMARY KEY,
  user_id TEXT NOT NULL,
  notification_id TEXT NOT NULL,
  read_at TEXT,
  reward_claimed INTEGER DEFAULT 0,
  claimed_at TEXT,

  UNIQUE(user_id, notification_id),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (notification_id) REFERENCES notifications(id) ON DELETE CASCADE
);
```

#### user_sessions

```sql
CREATE TABLE user_sessions (
  id TEXT PRIMARY KEY,
  user_id TEXT NOT NULL,
  refresh_token TEXT NOT NULL,
  expires_at TEXT NOT NULL,
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,
  last_used_at TEXT,
  device_info TEXT,
  ip_address TEXT,
  user_agent TEXT,
  is_active INTEGER DEFAULT 1,

  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

#### audit_logs

```sql
CREATE TABLE audit_logs (
  id TEXT PRIMARY KEY,
  user_id TEXT,
  action TEXT NOT NULL,
  details TEXT,
  severity TEXT DEFAULT 'info',
  ip_address TEXT,
  user_agent TEXT,
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,

  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
);
```

---

### Index de Performance

```sql
-- Users
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_is_admin ON users(is_admin);
CREATE INDEX idx_users_favorite_card_id ON users(favorite_card_id);

-- Cards
CREATE INDEX idx_cards_rarity ON cards(rarity);
CREATE INDEX idx_cards_type ON cards(type);
CREATE INDEX idx_cards_booster_id ON cards(booster_id);
CREATE UNIQUE INDEX idx_cards_vegapull_id ON cards(vegapull_id);

-- Collections
CREATE INDEX idx_user_collections_user_id ON user_collections(user_id);
CREATE INDEX idx_user_collections_card_id ON user_collections(card_id);

-- Booster Openings
CREATE INDEX idx_booster_openings_user_id ON booster_openings(user_id);
CREATE INDEX idx_booster_openings_booster_id ON booster_openings(booster_id);
CREATE INDEX idx_booster_openings_opened_at ON booster_openings(opened_at);

-- Achievements
CREATE INDEX idx_user_achievements_user_id ON user_achievements(user_id);
CREATE INDEX idx_user_achievements_achievement_id ON user_achievements(achievement_id);

-- Marketplace
CREATE INDEX idx_marketplace_seller_id ON marketplace_listings(seller_id);
CREATE INDEX idx_marketplace_buyer_id ON marketplace_listings(buyer_id);
CREATE INDEX idx_marketplace_card_id ON marketplace_listings(card_id);
CREATE INDEX idx_marketplace_status ON marketplace_listings(status);

-- Notifications
CREATE INDEX idx_user_notifications_user_id ON user_notifications(user_id);
CREATE INDEX idx_user_notifications_notification_id ON user_notifications(notification_id);

-- Sessions
CREATE INDEX idx_sessions_user_id ON user_sessions(user_id);
CREATE INDEX idx_sessions_refresh_token ON user_sessions(refresh_token);

-- Audit Logs
CREATE INDEX idx_audit_logs_user_id ON audit_logs(user_id);
CREATE INDEX idx_audit_logs_action ON audit_logs(action);
CREATE INDEX idx_audit_logs_severity ON audit_logs(severity);
CREATE INDEX idx_audit_logs_created_at ON audit_logs(created_at);
```

---

### Backup & Restore

**Backup Manuel:**
```bash
# Local
cp server/data/database.sqlite backups/database_$(date +%Y%m%d_%H%M%S).sqlite

# Docker
docker exec op-game-backend node scripts/backup-database.js
```

**Backup Automatique:**
```bash
# Configurer cron pour backup quotidien √† 2h00
docker exec op-game-backend sh -c 'crontab -l | { cat; echo "0 2 * * * node /app/scripts/backup-database.js"; } | crontab -'
```

**Restore:**
```bash
# Local
cp backups/database_20251007_120000.sqlite server/data/database.sqlite

# Docker
docker run --rm -v op_game_data:/data -v ~/backups:/backup \
  alpine cp /backup/database.sqlite /data/database.sqlite
```

---

### Requ√™tes SQL Utiles

**Statistiques Utilisateurs:**
```sql
SELECT
  COUNT(*) as total_users,
  SUM(is_admin) as total_admins,
  SUM(CASE WHEN datetime(last_login) > datetime('now', '-1 day') THEN 1 ELSE 0 END) as active_today,
  SUM(berrys) as total_berrys,
  AVG(berrys) as avg_berrys
FROM users
WHERE is_active = 1;
```

**Top Collectionneurs:**
```sql
SELECT
  u.username,
  COUNT(DISTINCT uc.card_id) as unique_cards,
  SUM(uc.quantity) as total_cards
FROM users u
LEFT JOIN user_collections uc ON u.id = uc.user_id
WHERE u.is_active = 1
GROUP BY u.id
ORDER BY unique_cards DESC
LIMIT 10;
```

**Leaderboard:**
```sql
SELECT
  username,
  berrys,
  (SELECT COUNT(DISTINCT card_id) FROM user_collections WHERE user_id = users.id) as unique_cards,
  (SELECT SUM(quantity) FROM user_collections WHERE user_id = users.id) as total_cards
FROM users
WHERE is_active = 1
ORDER BY berrys DESC
LIMIT 10;
```

---

## üîå API REST

### Structure des Endpoints

Tous les endpoints backend sont pr√©fix√©s par `/api`.

### Routes Publiques (Sans Auth)

```
POST /api/auth/register    - Cr√©er un compte
POST /api/auth/login       - Se connecter
POST /api/auth/logout      - Se d√©connecter
POST /api/auth/refresh     - Renouveler token
```

### Routes Authentifi√©es

**Auth:**
```
GET  /api/auth/me          - Info utilisateur courant
```

**Utilisateur:**
```
GET  /api/users/me                      - Profil complet
GET  /api/users/collection              - Collection de cartes
GET  /api/users/stats                   - Statistiques
GET  /api/users/boosters/status         - Statut boosters
POST /api/users/boosters/open           - Ouvrir booster
POST /api/users/boosters/buy            - Acheter booster
POST /api/users/cards/sell              - Vendre carte
POST /api/users/collection/favorite/:id - Toggle favori
GET  /api/users/berrys                  - Solde Berrys
GET  /api/users/daily-reward/status     - Statut daily reward
POST /api/users/daily-reward            - R√©clamer daily reward
PUT  /api/users/profile/favorite-card   - D√©finir carte vitrine
PUT  /api/users/password                - Changer password
```

**Cartes:**
```
GET  /api/cards             - Liste toutes les cartes
GET  /api/cards/:id         - D√©tail carte
GET  /api/cards/boosters    - Liste boosters
GET  /api/cards/boosters/:id - D√©tail booster
```

**Achievements:**
```
GET  /api/achievements         - Liste avec progression
GET  /api/achievements/stats   - Statistiques
POST /api/achievements/:id/claim - R√©clamer r√©compense
```

**Marketplace:**
```
GET    /api/marketplace/listings           - Toutes annonces actives
GET    /api/marketplace/my-listings        - Mes annonces
POST   /api/marketplace/listings           - Cr√©er annonce
POST   /api/marketplace/listings/:id/purchase - Acheter
DELETE /api/marketplace/listings/:id       - Annuler
```

**Notifications:**
```
GET  /api/notifications          - Non lues
POST /api/notifications/:id/claim - R√©clamer
```

**Leaderboard:**
```
GET  /api/leaderboard            - Top 3 joueurs
```

### Routes Admin

```
GET    /api/admin/dashboard/stats      - Statistiques globales
GET    /api/admin/dashboard/online     - Utilisateurs en ligne
GET    /api/admin/dashboard/activity   - Activit√© r√©cente
POST   /api/admin/notifications        - Cr√©er notification
GET    /api/admin/notifications        - Toutes notifications
DELETE /api/admin/notifications/:id    - D√©sactiver notification
```

---

### Exemples de Requ√™tes

**Inscription:**
```bash
curl -X POST http://localhost:5000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "luffy",
    "password": "goingmerry123",
    "email": "luffy@onepiece.com"
  }'
```

**Connexion:**
```bash
curl -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "luffy",
    "password": "goingmerry123"
  }'
```

**Ouvrir Booster:**
```bash
curl -X POST http://localhost:5000/api/users/boosters/open \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"boosterId": "booster-id"}'
```

**Acheter Booster:**
```bash
curl -X POST http://localhost:5000/api/users/boosters/buy \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"boosterId": "booster-id"}'
```

**Vendre Carte:**
```bash
curl -X POST http://localhost:5000/api/users/cards/sell \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "cardId": "card-id",
    "quantity": 1
  }'
```

**Cr√©er Annonce Marketplace:**
```bash
curl -X POST http://localhost:5000/api/marketplace/listings \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "cardId": "card-id",
    "price": 500
  }'
```

---

## üé® Design System

### Philosophie

**Glassmorphism Modern** - Tendance 2025 avec surfaces translucides, effets de flou et animations subtiles.

### Palette de Couleurs

**Ocean (Bleu - Grand Line):**
```css
ocean-50 √† ocean-950
Usage: Boutons primaires, liens actifs, √©l√©ments interactifs
```

**Treasure (Or/Ambre - Tr√©sors):**
```css
treasure-50 √† treasure-900
Usage: R√©compenses, achievements, highlights
```

**Danger (Rouge - Aventure):**
```css
danger-50 √† danger-900
Usage: Suppression, alertes, notifications importantes
```

**Secondaires:**
- **Slate:** Fonds, cartes, surfaces
- **Emerald:** Succ√®s, collection, progression
- **Purple:** Admin, premium

### Effets Glassmorphism

**Base Glass Card:**
```css
backdrop-blur-xl           /* Flou 24px */
bg-white/5                 /* Opacit√© 5% */
border border-white/10     /* Bordure subtile */
rounded-3xl                /* Coins arrondis */
shadow-2xl                 /* Ombre douce */
```

**Hover Effect:**
```css
hover:bg-white/10
hover:border-white/20
hover:shadow-[0_0_30px_rgba(59,130,246,0.3)]
hover:-translate-y-0.5
transition-all duration-300
```

### Composants UI

**Localisation:** `src/components/ui/`

**Button** (`Button.tsx`)
- Variants: primary, secondary, danger, treasure, ghost
- Sizes: sm, md, lg
- Props: isLoading, leftIcon, rightIcon, disabled

**GameCard** (`GameCard.tsx`)
- Variants: default, ocean, treasure, danger, success
- Props: hover, glow

**ProgressBar** (`ProgressBar.tsx`)
- Variants: ocean, treasure, success, danger
- Props: value, max, showLabel, label, animated

**StatDisplay** (`StatDisplay.tsx`)
- Variants: default, ocean, treasure, success, danger
- Sizes: sm, md, lg

**Dialog** (`Dialog.tsx`)
- Types: info, success, warning, error, confirm
- Hook: useDialog

### Typographie

```css
/* Titres */
text-4xl font-bold          /* Hero */
text-3xl font-bold          /* Page */
text-2xl font-bold          /* Section */
text-xl font-semibold       /* Subsection */

/* Corps */
text-base font-medium       /* Normal */
text-sm font-medium         /* Small */
text-xs font-medium         /* Tiny */

/* Labels */
text-sm font-medium uppercase tracking-wider
```

### Animations

```css
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes shimmer {
  0% { background-position: -1000px 0; }
  100% { background-position: 1000px 0; }
}

@keyframes pulse-slow {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}
```

### Background

**Gradient Principal:**
```css
background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
```

**Orbes Anim√©es:**
- Multiple orbes semi-transparentes color√©es
- Animation float
- Effet blur
- Position absolute

**Grid Overlay:**
```css
background-image:
  linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
  linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
background-size: 50px 50px;
```

### Breakpoints Responsive

```css
xs:  475px   /* Petits t√©l√©phones */
sm:  640px   /* T√©l√©phones */
md:  768px   /* Tablettes */
lg:  1024px  /* Desktop */
xl:  1280px  /* Large desktop */
2xl: 1536px  /* Extra large */
```

---

## üîß D√©pannage

### Frontend

**Probl√®me: "npm install" √©choue**

```bash
# Solution 1: R√©installation compl√®te
npm cache clean --force
rm -rf node_modules package-lock.json
npm install

# Solution 2: Avec legacy peer deps
npm install --legacy-peer-deps --no-optional

# Solution 3: Installation par √©tapes
npm install react@19.0.0 react-dom@19.0.0
npm install react-router-dom@^7.1.3
npm install lucide-react@^0.469.0
npm install -D vite@^6.0.7 @vitejs/plugin-react@^4.3.4
npm install -D typescript@^5.7.3
npm install -D tailwindcss@^3.4.17 autoprefixer@^10.4.20 postcss@^8.5.3
```

**Probl√®me: "npm run dev" √©choue**

```bash
# V√©rifier Vite install√©
npm list vite

# R√©installer si n√©cessaire
npm install -D vite@^6.0.7

# V√©rifier config
cat vite.config.ts
```

**Probl√®me: Tailwind CSS ne fonctionne pas**

```bash
# V√©rifier fichiers de config
ls tailwind.config.js
ls postcss.config.js

# V√©rifier imports Tailwind dans index.css
cat src/index.css
# Doit contenir:
# @tailwind base;
# @tailwind components;
# @tailwind utilities;
```

---

### Backend

**Probl√®me: Migrations √©chouent**

```bash
# V√©rifier chemin database
ls server/data/database.sqlite

# V√©rifier version sch√©ma
sqlite3 server/data/database.sqlite "PRAGMA user_version"

# Ex√©cuter migrations manuellement
cd server
node scripts/run-migrations.js
```

**Probl√®me: "database is locked"**

```bash
# Docker
docker-compose restart backend

# Local
# Tuer tous les processus node et red√©marrer
```

**Probl√®me: Collection vide apr√®s rebuild**

```bash
# Ex√©cuter diagnostic
node server/diagnose-database.js

# V√©rifier donn√©es existent
sqlite3 server/data/database.sqlite "SELECT COUNT(*) FROM user_collections"

# Si donn√©es existent mais query √©choue, rebuild backend
docker-compose build backend
docker-compose up -d backend
```

---

### Docker

**Probl√®me: Conteneur ne d√©marre pas**

```bash
# V√©rifier logs
docker logs op-game-backend
docker logs op-game-frontend

# V√©rifier images existent
docker images | grep op-game

# V√©rifier variables d'environnement
docker inspect op-game-backend | grep -A 20 Env
```

**Probl√®me: Status "Unhealthy"**

```bash
# Tester health backend
docker exec op-game-backend curl http://localhost:5000/health

# Tester health frontend
docker exec op-game-frontend curl http://localhost/

# V√©rifier logs
docker logs op-game-backend -f
```

**Probl√®me: Probl√®mes r√©seau entre conteneurs**

```bash
# V√©rifier r√©seau
docker network inspect op-game-network

# Tester connectivit√©
docker exec op-game-frontend ping backend

# V√©rifier config CORS
docker exec op-game-backend sh -c 'echo $ALLOWED_ORIGINS'
```

**Probl√®me: Donn√©es volume perdues**

```bash
# Lister volumes
docker volume ls | grep op_game

# Inspecter volume
docker volume inspect op_game_data

# Restore depuis backup
docker run --rm -v op_game_data:/data -v ~/backups:/backup \
  alpine cp /backup/database.sqlite /data/database.sqlite
```

---

### Raspberry Pi

**Probl√®me: Build trop long**

```bash
# Builder sur Windows, transf√©rer vers Pi
docker buildx build --platform linux/arm64 ...
docker save ... | gzip > image.tar.gz
scp image.tar.gz pi@raspberry:~/

# Sur Pi
docker load < image.tar.gz
```

**Probl√®me: Manque de m√©moire**

```bash
# Augmenter swap
sudo dphys-swapfile swapoff
sudo nano /etc/dphys-swapfile
# D√©finir CONF_SWAPSIZE=2048
sudo dphys-swapfile setup
sudo dphys-swapfile swapon
```

**Probl√®me: Performance lente**

```bash
# V√©rifier ressources
docker stats

# R√©duire limites m√©moire
# √âditer docker-compose:
services:
  backend:
    deploy:
      resources:
        limits:
          memory: 512M
```

---

### Authentification

**Probl√®me: Impossible de se connecter**

```bash
# V√©rifier secrets JWT configur√©s
docker exec op-game-backend sh -c 'echo $JWT_SECRET'

# R√©initialiser password
cd server
node scripts/make-admin.js <username>

# Ou SQL direct
sqlite3 data/database.sqlite
UPDATE users SET password_hash = 'NEW_BCRYPT_HASH' WHERE username = 'user';
```

**Probl√®me: Token expire imm√©diatement**

```bash
# V√©rifier JWT_EXPIRES_IN
docker exec op-game-backend sh -c 'echo $JWT_EXPIRES_IN'

# Devrait √™tre '15m' ou similaire
# Mettre √† jour dans .env ou docker-compose.yml
```

---

### Scripts de Diagnostic

**Collection:**
```bash
cd server
node diagnose-database.js
node verify-migration-state.js
node test-collections.js
```

**S√©curit√©:**
```bash
cd server
node security-check.js
node security-penetration-tests.js
```

**Notifications:**
```bash
cd server
node test-notification-security.js
```

**Raret√©s:**
```bash
cd server
npx tsx src/scripts/diagnose-rarity-issues.ts
npx tsx src/scripts/fix-all-rarities.ts
```

---

## üêõ Corrections Appliqu√©es

### Bug Critique Datetime (2025-10-07)

**Probl√®me:** `datetime('now')` ne fonctionne pas dans les requ√™tes param√©tr√©es avec better-sqlite3.

**Impact:** ‚ùå Login, Daily reward, Booster opening, Collection, Achievements - Tout cass√©

**Solution:** Remplacement de tous les `datetime('now')` par `new Date().toISOString()` en JavaScript.

**Fichiers corrig√©s:**
- `server/src/models/User.ts` - 3 occurrences
- `server/src/controllers/authController.ts` - 2 occurrences
- `server/src/controllers/userController.ts` - 8 occurrences

**R√©sultat:** ‚úÖ Toutes les fonctionnalit√©s restaur√©es

---

### Bug Collection Vide (2025-10-07)

**Probl√®me:** Utilisateurs voyaient Berrys/boosters mais AUCUNE carte dans la collection apr√®s rebuild Docker.

**Cause:** Requ√™te SQL manquait des colonnes essentielles dans le SELECT.

**Solution:** Ajout colonnes manquantes:
```sql
SELECT
  uc.user_id, uc.card_id, uc.quantity, uc.obtained_at, uc.is_favorite,
  c.id, c.name, c.character_name, c.rarity, c.type, c.color,
  c.cost, c.power, c.counter,
  c.attack, c.defense,  -- AJOUT√â
  c.description, c.special_ability,
  c.image_url, c.fallback_image_url,
  c.booster_id, c.vegapull_id, c.is_active  -- AJOUT√â
FROM user_collections uc
JOIN cards c ON uc.card_id = c.id
```

**Fichier:** `server/src/controllers/userController.ts`

---

### Bug Double Daily Reward

**Probl√®me:** Utilisateurs pouvaient r√©clamer 10 Berrys infiniment en rafra√Æchissant la page.

**Cause:** Colonne `last_daily_reward` jamais mise √† jour (bug datetime).

**Solution:** Clause WHERE atomique:
```sql
UPDATE users
SET berrys = COALESCE(berrys, 0) + ?,
    last_daily_reward = ?
WHERE id = ?
  AND (last_daily_reward IS NULL OR date(last_daily_reward) < date(?))
```

**R√©sultat:** Protection triple (frontend + backend + database) emp√™che doubles r√©clamations.

---

### Bug Consommation Boosters

**Probl√®me:** Boosters gratuits non consomm√©s lors de l'ouverture.

**Cause:** Race condition entre v√©rification et transaction.

**Solution:** V√©rification DANS la transaction avec UPDATE atomique:
```typescript
await Database.transaction(async () => {
  const currentUser = await Database.get(`
    SELECT available_boosters FROM users WHERE id = ?
  `, [userId]);

  if (!currentUser || currentUser.available_boosters <= 0) {
    throw new Error('No boosters available');
  }

  const updateResult = await Database.run(`
    UPDATE users
    SET available_boosters = available_boosters - 1
    WHERE id = ? AND available_boosters > 0
  `, [userId]);

  if (updateResult.changes === 0) {
    throw new Error('No boosters available');
  }
});
```

---

### Bugs Raret√©s (2025-10-12)

**Probl√®me 1:** Toutes les cartes Leader import√©es avec `rarity='common'` au lieu de `rarity='leader'`.

**Cause:** RARITY_MAPPING manquait `'Leader': 'leader'`.

**Probl√®me 2:** Raret√©s manquantes dans le mapping:
- `'Special'` ‚Üí devrait √™tre `'super_rare'` (√©tait `'common'`)
- `'Promo'` ‚Üí devrait √™tre `'rare'` (√©tait `'common'`)
- `'TreasureRare'` ‚Üí devrait √™tre `'secret_rare'` (√©tait `'common'`)

**Solution:** RARITY_MAPPING complet:
```typescript
const RARITY_MAPPING: Record<string, string> = {
  'Leader': 'leader',
  'SuperRare': 'super_rare',
  'Rare': 'rare',
  'Uncommon': 'uncommon',
  'Common': 'common',
  'SecretRare': 'secret_rare',
  'SpecialRare': 'secret_rare',
  'TreasureRare': 'secret_rare',  // AJOUT√â
  'Special': 'super_rare',        // AJOUT√â
  'Promo': 'rare'                 // AJOUT√â
};
```

**Auto-correction:** Script s'ex√©cute automatiquement au d√©marrage Docker via `docker-entrypoint.sh`.

**Probl√®me 3:** Leaders affich√©s dans le mauvais ordre dans la Collection.

**Cause:** `rarityOrder` array manquait `'leader'`.

**Solution:**
```typescript
const rarityOrder = ['secret_rare', 'super_rare', 'leader', 'rare', 'uncommon', 'common'];
```

**Fichiers:**
- `server/src/scripts/import-vegapull-data.ts`
- `server/src/scripts/fix-all-rarities.ts`
- `src/pages/Collection.tsx`

---

### Bug Auth Marketplace

**Probl√®me:** Toutes les actions marketplace retournaient 401 Unauthorized.

**Cause:** Page utilisait `fetch` avec `localStorage.getItem('token')` au lieu de `apiService` avec gestion appropri√©e des tokens.

**Solution:** Remplacement de tous les fetch par apiService:
```typescript
// Avant
const response = await fetch(`${API_URL}/marketplace/listings`, {
  headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
});

// Apr√®s
const response = await apiService.getMarketplaceListings();
```

**Fichiers:**
- `src/services/api.ts` - Ajout 5 m√©thodes marketplace
- `src/pages/Marketplace.tsx` - Remplacement tous fetch

---

### Bug "No Sellable Cards" Marketplace

**Probl√®me:** Message "No sellable cards" m√™me avec doublons.

**Cause:** Requ√™te SQL utilisait `c.character` mais colonne nomm√©e `character_name`.

**Solution:**
```sql
-- Avant
SELECT c.character, ...

-- Apr√®s
SELECT c.character_name as character, ...
```

**Fichier:** `server/src/controllers/userController.ts`

---

### Bug Limite Affichage Cartes

**Probl√®me:** Seulement 100 cartes affich√©es au lieu des 2,628.

**Cause:** Backend imposait limite artificielle de 100 cartes par requ√™te.

**Solution:** Retrait limite artificielle:
```typescript
// Avant
const limit = Math.max(1, Math.min(parseInt(req.query.limit as string) || 50, 100));

// Apr√®s
const limit = parseInt(req.query.limit as string) || 10000;
```

**Fichiers:**
- `server/src/controllers/cardController.ts`
- `src/services/gameService.ts`

---

## üìù Variables d'Environnement

### Obligatoires (Production)

```env
JWT_SECRET=<g√©n√©rer avec: openssl rand -base64 32>
JWT_REFRESH_SECRET=<g√©n√©rer diff√©rent>
ADMIN_PASSWORD=VotreMotDePasseS√©curis√©123!
```

### Optionnelles

```env
# JWT
JWT_EXPIRES_IN=15m
JWT_REFRESH_EXPIRES_IN=7d

# Bcrypt
BCRYPT_ROUNDS=10

# Admin
ADMIN_USERNAME=admin
ADMIN_EMAIL=admin@example.com

# CORS
ALLOWED_ORIGINS=http://localhost,http://your-domain.com

# Cookies
COOKIE_DOMAIN=.yourdomain.com

# Environment
NODE_ENV=production

# Ports
BACKEND_PORT=5000
FRONTEND_PORT=80
```

---

## üìÑ Licence

Ce projet est une application de d√©monstration. Les cartes et images One Piece TCG appartiennent √† leurs propri√©taires respectifs.

---

## ü§ù Contribution

Contributions, issues et feature requests sont les bienvenues !

---

## üëè Remerciements

- **Bandai Namco** - One Piece Trading Card Game
- **Vegapull** - Donn√©es des cartes
- **React Community**
- **Tailwind CSS Team**

---

üè¥‚Äç‚ò†Ô∏è **Bon voyage sur Grand Line, moussaillon !**
